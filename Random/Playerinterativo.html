<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Interattivo Avanzato - Ottimizzato Cross-Platform</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
  <style>
    :root { /* Variabili CSS come prima */
      --primary-bg: #0a0a0a; --secondary-bg: #1a1a1a; --accent-bg: #2a2a2a;
      --primary-text: #ffffff; --secondary-text: #cccccc; --accent-color: #00d4ff;
      --success-color: #00ff88; --warning-color: #ffaa00; --error-color: #ff4444;
      --border-radius: 8px; --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%); color: var(--primary-text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    input, textarea { user-select: auto; -webkit-user-select: auto; -moz-user-select: auto; -ms-user-select: auto; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1, h2 { text-align: center; margin-bottom: 2rem; background: linear-gradient(45deg, var(--accent-color), var(--success-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    #builder { background: var(--secondary-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2rem; }
    .toolbar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: var(--accent-bg); border-radius: var(--border-radius); }
    .btn { background: linear-gradient(45deg, var(--accent-color), #0099cc); color: white; border: none; padding: 12px 20px; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
    .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
    .btn:hover::before { left: 100%; } .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 255, 0.3); }
    .btn.small-btn { padding: 6px 10px; font-size: 0.85em; } .btn.danger { background: linear-gradient(45deg, var(--error-color), #cc0000); } .btn.warning { background: linear-gradient(45deg, var(--warning-color), #cc8800); } .btn.success { background: linear-gradient(45deg, var(--success-color), #00cc66); }
    .segment { background: var(--accent-bg); margin-bottom: 1.5rem; padding: 1.5rem; border-radius: var(--border-radius); border-left: 4px solid var(--accent-color); box-shadow: var(--shadow); transition: transform 0.3s ease; }
    .segment:hover { transform: translateX(5px); }
    .form-group { margin-bottom: 1rem; } label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-text); }
    input { width: 100%; padding: 12px; background: var(--secondary-bg); border: 2px solid transparent; border-radius: var(--border-radius); color: var(--primary-text); font-size: 14px; transition: all 0.3s ease; }
    input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1); }
    input.time-input { max-width: 200px; font-family: monospace; }
    #share-link { font-family: monospace; font-size: 12px; background: var(--primary-bg); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .interaction-point-block { background: var(--primary-bg); padding: 1rem; margin-top: 1rem; border-radius: var(--border-radius); border: 1px dashed var(--accent-color); }
    .interaction-point-block h3 { margin-top: 0; font-size: 1.1em; color: var(--accent-color); border-bottom: 1px solid var(--accent-bg); padding-bottom: 0.5em; margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center;}
    .options-list { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem; padding-left: 1rem; border-left: 2px solid var(--accent-color); }
    .option-item { background: var(--primary-bg); padding: 1rem; border-radius: var(--border-radius); display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; align-items: end; }
    .option-item input { font-size: 13px; padding: 8px; }
    .option-item .remove-option-btn, .option-item .edit-hotspot-btn { padding: 8px 12px; font-size: 0.9em; margin-top: 0.5em; }
    .option-item .edit-hotspot-btn { background: linear-gradient(45deg, var(--warning-color), #b37700); }
    .add-option-to-point-btn { margin-top: 0.5rem; background: linear-gradient(45deg, var(--accent-color), #0077aa) !important; padding: 8px 15px !important; font-size: 0.9em !important; }
    .add-interaction-point-btn { margin-top: 1rem; background: linear-gradient(45deg, var(--success-color), #00aa44); padding: 10px 18px; font-size: 0.95em; width: auto; display: inline-block; margin-bottom: 1rem;}
    .help-text { background-color: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: var(--border-radius); margin-top: -0.5rem; margin-bottom: 1rem; font-size: 0.85em; color: var(--secondary-text); border-left: 3px solid var(--warning-color); }
    .help-text p { margin: 0.5em 0; } .help-text ul { margin: 0.5em 0; padding-left: 20px; } .help-text li { margin-bottom: 0.3em; } .help-text strong { color: var(--primary-text); } .help-text em { color: var(--accent-color); font-style: normal; } .help-text code { background-color: var(--primary-bg); padding: 2px 4px; border-radius: 4px; font-family: monospace; color: var(--success-color); }
    #player-container { display: none; background: var(--secondary-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2rem; position: relative; margin-left:auto; margin-right:auto; }
    #player-container:fullscreen, #player-container:-webkit-full-screen, #player-container:-moz-full-screen, #player-container:-ms-fullscreen { background: #000; padding: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    #player-container video { display: block; width: 100%; height: auto; max-height: 80vh; object-fit: contain; background: #000; border-radius: var(--border-radius); }
    #player-container:fullscreen video, #player-container:-webkit-full-screen video, #player-container:-moz-full-screen video, #player-container:-ms-fullscreen video { border-radius: 0; max-width: 100vw; max-height: 100vh; object-fit: contain; width: auto; height: auto; }
    .choice-btn { margin: 0.5rem; background: linear-gradient(45deg, var(--accent-color), #0099cc); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3); }
    .choice-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4); }
    #choices { display: none; text-align: center; margin-top: 1rem; padding: 1rem; background: rgba(26, 26, 26, 0.9); border-radius: var(--border-radius); position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: fit-content; z-index: 20; }
    .choice-box { position: absolute; border: 3px solid var(--accent-color); background: rgba(0, 212, 255, 0.2); cursor: pointer; border-radius: var(--border-radius); transition: all 0.3s ease; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); z-index: 21; }
    .choice-box:hover { background: rgba(0, 212, 255, 0.4); transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 212, 255, 0.6); }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: var(--accent-color); animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: var(--border-radius); color: white; font-weight: 600; z-index: 1002; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .notification.show { transform: translateX(0); } .notification.success { background: var(--success-color); color: var(--primary-bg); } .notification.error { background: var(--error-color); }
    .video-controls-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; display: flex; justify-content: center; align-items: center; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); opacity: 0; transition: opacity 0.3s ease, visibility 0.3s ease; visibility: hidden; border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); z-index: 10; }
    #player-container:not(:fullscreen):hover .video-controls-overlay { opacity: 1; visibility: visible; }
    .video-controls-overlay .btn { padding: 8px 15px; font-size: 0.9em; margin: 0 5px; }
    #player-container:fullscreen .video-controls-overlay, #player-container:-webkit-full-screen .video-controls-overlay, #player-container:-moz-full-screen .video-controls-overlay, #player-container:-ms-fullscreen .video-controls-overlay { display: none !important; }
    .back-btn { position: absolute; top: 10px; left: 10px; background: rgba(26, 26, 26, 0.9); border: 2px solid var(--accent-color); color: var(--accent-color); padding: 8px 12px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px); z-index: 30; }
    #player-container:fullscreen .back-btn, #player-container:-webkit-full-screen .back-btn, #player-container:-moz-full-screen .back-btn, #player-container:-ms-fullscreen .back-btn { display: none !important; }
    .back-btn:hover { background: var(--accent-color); color: var(--primary-bg); }
    .modal { position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; }
    .modal-content { background-color: var(--secondary-bg); margin: auto; padding: 20px; border: 1px solid var(--accent-color); border-radius: var(--border-radius); width: 90%; box-shadow: var(--shadow); color: var(--primary-text); position: relative; }
    .modal-content.large { max-width: 900px; } .modal-content:not(.large) { max-width: 700px; }
    .close-modal-btn { color: var(--secondary-text); float: right; font-size: 28px; font-weight: bold; transition: color 0.3s; }
    .close-modal-btn:hover, .close-modal-btn:focus { color: var(--accent-color); text-decoration: none; cursor: pointer; }
    .modal-body { padding: 10px 0; } .modal-footer { padding-top: 15px; text-align: right; } .modal-footer .btn { margin-left: 10px; }
    #visual-editor-container { position: relative; width: 100%; background-color: #000; margin-bottom: 10px; border: 1px solid var(--accent-bg); overflow: hidden; }
    #video-preview-canvas { display: block; width: 100%; height: 100%; object-fit: contain; }
    #resizable-hotspot-preview { position: absolute; border: 2px dashed var(--success-color); background-color: rgba(0, 255, 136, 0.2); cursor: move; box-sizing: border-box; }
    .resize-handle { position: absolute; width: 12px; height: 12px; background-color: var(--success-color); border: 1px solid var(--primary-bg); border-radius: 2px; z-index: 10; }
    .resize-handle.nw { top: -6px; left: -6px; cursor: nwse-resize; } .resize-handle.ne { top: -6px; right: -6px; cursor: nesw-resize; } .resize-handle.sw { bottom: -6px; left: -6px; cursor: nesw-resize; } .resize-handle.se { bottom: -6px; right: -6px; cursor: nwse-resize; } .resize-handle.n { top: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; } .resize-handle.s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; } .resize-handle.w { top: 50%; left: -6px; transform: translateY(-50%); cursor: ew-resize; } .resize-handle.e { top: 50%; right: -6px; transform: translateY(-50%); cursor: ew-resize; }
    #hotspot-values-preview { font-family: monospace; font-size: 0.9em; color: var(--secondary-text); padding: 8px; background-color: var(--primary-bg); border-radius: var(--border-radius); text-align: center; }
    #timeline-video-container video { width: 100%; height: auto; max-height: 400px; background: #000; border-radius: var(--border-radius); }
    #timeline-controls { display: flex; align-items: center; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
    #timeline-controls label { margin-bottom: 0; }
    #timeline-bar-container { position: relative; width: 100%; height: 20px; background-color: var(--accent-bg); border-radius: 4px; margin: 15px 0; padding: 0 5px; }
    #timeline-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 100%; background: transparent; outline: none; position: absolute; top: 0; left: 0; z-index: 5; cursor: pointer; }
    #timeline-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-color); border-radius: 50%; cursor: grab; border: 2px solid var(--primary-bg); margin-top: -3px; }
    #timeline-slider::-moz-range-thumb { width: 16px; height: 16px; background: var(--accent-color); border-radius: 50%; cursor: grab; border: 2px solid var(--primary-bg); }
    .timeline-marker { position: absolute; top: 50%; transform: translateY(-50%) translateX(-50%); width: 10px; height: 25px; background-color: var(--warning-color); border-radius: 3px; z-index: 6; cursor: grab; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    #choice-point-marker { background-color: var(--success-color); }
    
    @media (max-width: 768px) {
      .container { padding: 10px; }
      h1 { font-size: 1.8em; } h2 { font-size: 1.5em; }
      .btn { padding: 10px 15px; font-size: 0.95em; } .btn.small-btn { padding: 8px 10px; font-size: 0.8em; }
      input, .time-input { padding: 10px; font-size: 1em; }
      #builder { padding: 1rem; }
      .toolbar { grid-template-columns: 1fr 1fr; }
      .segment { padding: 1rem; }
      .form-grid { grid-template-columns: 1fr; }
      .interaction-point-block .form-group, .option-item { grid-template-columns: 1fr; }
      .interaction-point-block h3 { font-size: 1em; flex-direction: column; align-items: flex-start; }
      .interaction-point-block h3 .remove-interaction-point-btn { margin-top: 0.5em; align-self: flex-end; }
      .option-item .remove-option-btn, .option-item .edit-hotspot-btn { grid-column: auto; width: fit-content; margin-left: auto; }
      .option-item input[type="number"] { max-width: 150px; }
      #player-container { padding: 10px; } #player-container video { max-height: 70vh; }
      .choice-box { font-size: 11px; border-width: 2px; padding: 5px; }
      .video-controls-overlay { padding: 5px; } .video-controls-overlay .btn { padding: 6px 10px; font-size: 0.8em; }
      .help-text { font-size: 0.8em; padding: 8px; }
      .back-btn { padding: 6px 10px; font-size: 0.9em; top:5px; left:5px;}
      .modal-content { width: 95%; padding:15px; max-height: 90vh; overflow-y: auto; }
      .modal-footer .btn { font-size:0.9em; padding:8px 12px; }
      #timeline-video-container video { max-height: 200px; } 
      #visual-editor-container { max-height: 30vh; /* Riduci ulteriormente per schermi piccoli */ }
      .resize-handle { width: 18px; height: 18px; } /* Maniglie pi√π grandi */
      .resize-handle.nw { top: -9px; left: -9px; } .resize-handle.ne { top: -9px; right: -9px; } .resize-handle.sw { bottom: -9px; left: -9px; } .resize-handle.se { bottom: -9px; right: -9px; }
      .resize-handle.n { top: -9px;} .resize-handle.s { bottom: -9px;} .resize-handle.w { left: -9px;} .resize-handle.e { right: -9px;}
      .stats { grid-template-columns: 1fr; } .stat-card { padding: 0.8rem; } .stat-number { font-size: 1.5rem; } .stat-label { font-size: 0.8rem; }
    }
    @media (max-width: 480px) {
        h1 { font-size: 1.5em; }
        .toolbar { grid-template-columns: 1fr; } 
        .btn { font-size: 0.9em; }
        .option-item .remove-option-btn, .option-item .edit-hotspot-btn { width: 100%; margin-left: 0; }
        #visual-editor-container { max-height: 25vh; }
    }

    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--accent-bg); padding: 1rem; border-radius: var(--border-radius); text-align: center; border-left: 4px solid var(--success-color); }
    .stat-number { font-size: 2rem; font-weight: bold; color: var(--success-color); }
    .stat-label { color: var(--secondary-text); font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <div id="builder">
      <h1>üé¨ Player Interattivo Avanzato</h1>
      <div class="stats" id="stats"> <div class="stat-card"><div class="stat-number" id="segment-count">0</div><div class="stat-label">Segmenti Video</div></div> <div class="stat-card"><div class="stat-number" id="choice-count">0</div><div class="stat-label">Opzioni Totali</div></div> <div class="stat-card"><div class="stat-number" id="duration-count">0:00</div><div class="stat-label">Durata Totale</div></div> </div>
      <div class="toolbar"> <button class="btn" id="add-segment">‚ûï Aggiungi Segmento Video</button> <button class="btn" id="export-config">üíæ Esporta</button> <button class="btn" id="import-config">üìÅ Importa</button> <button class="btn" id="share-config">üîó Condividi</button> <button class="btn success" id="start-player">‚ñ∂Ô∏è Avvia Player</button> <button class="btn danger" id="clear-all">üóëÔ∏è Cancella Tutto</button> </div>
      <input type="file" id="import-file" accept="application/json" style="display:none;"> <input type="text" id="share-link" readonly placeholder="Link condivisibile verr√† generato qui..."> <div id="segments"></div>
    </div>
    <div id="player-container"> <button class="back-btn" id="back-to-builder">‚Üê Torna al Builder</button> <video id="video" preload="metadata"></video> <div class="video-controls-overlay"> <button class="btn" id="restart-story">üîÑ Ricomincia</button> <button class="btn" id="toggle-fullscreen">‚õ∂ Schermo Intero</button> </div> <div id="choices"></div> </div>
    <div id="hotspot-editor-modal" class="modal"> <div class="modal-content"> <span class="close-modal-btn">√ó</span> <h2>Editor Hotspot Visivo</h2> <div class="modal-body"> <div id="visual-editor-container"> <canvas id="video-preview-canvas"></canvas> <div id="resizable-hotspot-preview"> <div class="resize-handle nw"></div><div class="resize-handle ne"></div> <div class="resize-handle sw"></div><div class="resize-handle se"></div> <div class="resize-handle n"></div><div class="resize-handle s"></div> <div class="resize-handle w"></div><div class="resize-handle e"></div> </div> </div> <div id="hotspot-values-preview"> X: <span id="modal-hotspot-x">0</span>% | Y: <span id="modal-hotspot-y">0</span>% | W: <span id="modal-hotspot-w">0</span>% | H: <span id="modal-hotspot-h">0</span>% </div> <video id="temp-video-for-frame" style="display:none;" preload="metadata" muted playsinline crossOrigin="anonymous"></video> </div> <div class="modal-footer"> <button id="apply-hotspot-changes" class="btn success">Applica</button> <button id="cancel-hotspot-changes" class="btn danger">Annulla</button> </div> </div> </div>
    <div id="timeline-editor-modal" class="modal"> <div class="modal-content large"> <span class="close-modal-btn">√ó</span> <h2>Editor Timeline per Punto di Interazione</h2> <div class="modal-body"> <div id="timeline-video-container"><video id="timeline-preview-video" controls preload="metadata"></video></div> <div id="timeline-controls"> <label for="current-interaction-point-time">Tempo Punto Interazione:</label> <input type="text" id="current-interaction-point-time" class="time-input" readonly> <button id="set-interaction-point-time-here" class="btn small-btn success">Imposta Qui</button> </div> <div id="timeline-bar-container"> <input type="range" id="timeline-slider" value="0" min="0" max="1000" step="0.1"> <div id="choice-point-marker" class="timeline-marker"></div> </div> <p style="font-size:0.8em; text-align:center;">Tempo: <span id="timeline-current-time">0:00</span> / <span id="timeline-total-duration">0:00</span></p> </div> <div class="modal-footer"> <button id="apply-timeline-changes" class="btn success">Applica e Chiudi</button> <button id="cancel-timeline-changes" class="btn danger">Annulla</button> </div> </div> </div>
  </div>

<script>
  class InteractiveVideoPlayer {
    constructor() {
      this.storyConfig = { start: null, durations: {}, segments: {} }; this.resumeStack = []; 
      this.pendingChoicesInSegment = []; this.nextChoicePointIndex = 0;    
      this.currentHls = null; this.stats = { choices: 0, totalDuration: 0 }; 
      this.currentEditingOption = { segmentSrcInput: null, optionItemDiv: null, inputX: null, inputY: null, inputW: null, inputH: null };
      this.hotspotPreviewState = { x: 0, y: 0, w: 20, h: 10, isDragging: false, isResizing: false, dragStartX: 0, dragStartY: 0, resizeHandle: null, originalX: 0, originalY: 0, originalW: 0, originalH: 0, containerWidth:0, containerHeight:0, dragOffsetXPercent:0, dragOffsetYPercent:0 };
      this.videoFrameExtractor = document.getElementById('temp-video-for-frame');
      this.previewCanvas = document.getElementById('video-preview-canvas'); this.previewCtx = this.previewCanvas.getContext('2d');
      this.resizableHotspotPreview = document.getElementById('resizable-hotspot-preview');
      this.currentEditingInteractionPoint = { interactionPointDiv: null, timeInput: null, segmentSrcProvider: null };
      this.timelineVideo = document.getElementById('timeline-preview-video');
      this.timelineSlider = document.getElementById('timeline-slider');
      this.choicePointMarker = document.getElementById('choice-point-marker'); 
      
      this.initEventListeners(); this.initModalEventListeners(); this.initTimelineModalEventListeners(); 
      this.checkUrlConfig(); this.updateStats(); 
    }

    initEventListeners() { document.getElementById('add-segment').onclick = () => this.createSegmentUI(); document.getElementById('export-config').onclick = () => this.exportConfig(); document.getElementById('import-config').onclick = () => document.getElementById('import-file').click(); document.getElementById('import-file').onchange = (e) => this.importConfig(e); document.getElementById('share-config').onclick = () => this.shareConfig(); document.getElementById('start-player').onclick = () => this.startPlayer(); document.getElementById('clear-all').onclick = () => this.clearAll(); document.getElementById('back-to-builder').onclick = () => this.backToBuilder(); document.getElementById('restart-story').onclick = () => this.restartStory(); document.getElementById('toggle-fullscreen').onclick = () => this.toggleFullscreen(); }
    initModalEventListeners() { const modal = document.getElementById('hotspot-editor-modal'); const closeModalBtn = modal.querySelector('.close-modal-btn'); const applyBtn = document.getElementById('apply-hotspot-changes'); const cancelBtn = document.getElementById('cancel-hotspot-changes'); closeModalBtn.onclick = () => this.closeHotspotModal(); cancelBtn.onclick = () => this.closeHotspotModal(); applyBtn.onclick = () => this.applyHotspotChanges(); window.addEventListener('click', (event) => { if (event.target === modal) { this.closeHotspotModal(); } }); this.resizableHotspotPreview.addEventListener('mousedown', (e) => this.handleHotspotMouseDown(e)); document.addEventListener('mousemove', (e) => this.handleHotspotMouseMove(e)); document.addEventListener('mouseup', (e) => this.handleHotspotMouseUp(e)); }
    initTimelineModalEventListeners() { const modal = document.getElementById('timeline-editor-modal'); const closeModalBtn = modal.querySelector('.close-modal-btn'); const applyBtn = document.getElementById('apply-timeline-changes'); const cancelBtn = document.getElementById('cancel-timeline-changes'); const setTimeBtn = document.getElementById('set-interaction-point-time-here'); closeModalBtn.onclick = () => this.closeTimelineModal(); cancelBtn.onclick = () => this.closeTimelineModal(); applyBtn.onclick = () => this.applyTimelineChangesForInteractionPoint(); setTimeBtn.onclick = () => this.setInteractionPointTimeFromVideo(); window.addEventListener('click', (event) => { if (event.target === modal) { this.closeTimelineModal(); } }); this.timelineVideo.onloadedmetadata = () => { if(!this.timelineVideo.duration || !isFinite(this.timelineVideo.duration)) return; document.getElementById('timeline-total-duration').textContent = this.formatTime(this.timelineVideo.duration); this.timelineSlider.max = this.timelineVideo.duration; this.updateTimelineUIForInteractionPoint(); }; this.timelineVideo.ontimeupdate = () => { if(!this.timelineVideo.duration || !isFinite(this.timelineVideo.duration)) return; document.getElementById('timeline-current-time').textContent = this.formatTime(this.timelineVideo.currentTime); if (!this.timelineSlider.isDraggingMarker && document.getElementById('timeline-editor-modal').style.display === 'flex') { this.timelineSlider.value = this.timelineVideo.currentTime; } }; this.timelineSlider.addEventListener('input', () => { if (this.timelineVideo.duration) this.timelineVideo.currentTime = parseFloat(this.timelineSlider.value); }); this.timelineSlider.addEventListener('mousedown', () => { this.timelineSlider.isDraggingMarker = true; }); this.timelineSlider.addEventListener('mouseup', () => { this.timelineSlider.isDraggingMarker = false; }); this.choicePointMarker.onmousedown = (e) => { e.preventDefault(); const marker = this.choicePointMarker; marker.isDragging = true; document.onmousemove = (moveEvent) => { if (!marker.isDragging) return; const rect = this.timelineSlider.getBoundingClientRect(); let newLeft = moveEvent.clientX - rect.left; let newPercent = (newLeft / rect.width) * 100; newPercent = Math.max(0, Math.min(100, newPercent)); const videoDuration = this.timelineVideo.duration || parseFloat(this.timelineSlider.max) || 0; const newTime = (newPercent / 100) * videoDuration; document.getElementById('current-interaction-point-time').value = this.formatTime(newTime); marker.style.left = `${newPercent}%`; }; document.onmouseup = () => { marker.isDragging = false; document.onmousemove = null; document.onmouseup = null; const newTimeSeconds = this.parseTime(document.getElementById('current-interaction-point-time').value); if (isFinite(newTimeSeconds) && this.timelineVideo.duration > 0) { this.timelineVideo.currentTime = newTimeSeconds; this.timelineSlider.value = newTimeSeconds; }}; };}
    
    showNotification(message, type = 'success') { const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message; document.body.appendChild(notification); requestAnimationFrame(() => { setTimeout(() => notification.classList.add('show'), 50); }); setTimeout(() => { notification.classList.remove('show'); setTimeout(() => document.body.removeChild(notification), 400); }, 3000); }
    updateStats() { this.buildConfig(); const segmentUIElementsCount = document.getElementById('segments').children.length; document.getElementById('segment-count').textContent = segmentUIElementsCount; let totalChoices = 0; Object.values(this.storyConfig.segments).forEach(interactionPointsArray => { interactionPointsArray.forEach(point => { totalChoices += point.options.length; }); }); this.stats.choices = totalChoices; this.stats.totalDuration = Object.values(this.storyConfig.durations).reduce((total, duration) => total + (duration || 0), 0); document.getElementById('choice-count').textContent = this.stats.choices; document.getElementById('duration-count').textContent = this.formatTime(this.stats.totalDuration); }
    parseTime(timeStr) { if (!timeStr) return 0; const parts = timeStr.split(':').map(p => parseFloat(p) || 0); if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2]; if (parts.length === 2) return parts[0] * 60 + parts[1]; return parts[0] || 0; }
    
    formatTime(seconds) {
        if (seconds === null || seconds === undefined || isNaN(seconds) || !isFinite(seconds)) return '0:00';
        if (seconds < 0) seconds = 0; 
        let h = Math.floor(seconds / 3600);
        let m = Math.floor((seconds % 3600) / 60);
        let s = Math.floor(seconds % 60);
        const sStr = s.toString().padStart(2, '0');
        if (h > 0) {
            const mStr = m.toString().padStart(2, '0');
            return `${h}:${mStr}:${sStr}`;
        } else {
            return `${m}:${sStr}`; 
        }
    }

    addInteractionPointUI(interactionPointsListContainer, segmentSrcProvider, interactionData = {}) {
        const pointDiv = document.createElement('div'); pointDiv.className = 'interaction-point-block';
        const timeInputId = `interaction-time-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
        pointDiv.innerHTML = `<h3>Punto di Interazione <button type="button" class="btn danger remove-interaction-point-btn small-btn" title="Rimuovi Punto">‚úñ</button></h3> <div class="form-group"> <label for="${timeInputId}">üéØ Tempo Attivazione (es. 1:20):</label> <input type="text" id="${timeInputId}" name="interaction_time" class="time-input" value="${interactionData.time ? this.formatTime(interactionData.time) : '0:00'}" placeholder="Lascia vuoto per fine video"> <button type="button" class="btn timeline-editor-btn-for-point small-btn success" style="margin-left:10px;">üìä Timeline</button> </div> <div class="form-group"> <label>üéÆ Opzioni per questo Punto:</label> <div class="options-list"></div> <button type="button" class="btn add-option-to-point-btn small-btn">‚ûï Opzione</button> </div>`;
        const optionsList = pointDiv.querySelector('.options-list'); const addOptionBtn = pointDiv.querySelector('.add-option-to-point-btn'); const removePointBtn = pointDiv.querySelector('.remove-interaction-point-btn'); const timeInputForPoint = pointDiv.querySelector('input[name="interaction_time"]'); const timelineBtnForPoint = pointDiv.querySelector('.timeline-editor-btn-for-point');
        addOptionBtn.onclick = () => { const segmentSrc = typeof segmentSrcProvider === 'function' ? segmentSrcProvider() : (segmentSrcProvider ? segmentSrcProvider.value.trim() : ''); this.addOptionToSegmentUI(optionsList, segmentSrc); };
        removePointBtn.onclick = () => { pointDiv.remove(); this.buildConfig(); this.updateStats(); };
        timeInputForPoint.addEventListener('input', () => { this.buildConfig(); this.updateStats(); });
        timelineBtnForPoint.onclick = () => { const segmentSrc = typeof segmentSrcProvider === 'function' ? segmentSrcProvider() : (segmentSrcProvider ? segmentSrcProvider.value.trim() : ''); if (!segmentSrc) { this.showNotification("Definisci SRC del segmento video padre.", "error"); return; } this.currentEditingInteractionPoint = { interactionPointDiv: pointDiv, timeInput: timeInputForPoint, segmentSrcProvider: () => segmentSrc }; this.openTimelineModalForInteractionPoint(); };
        if (interactionData.options && Array.isArray(interactionData.options)) { const segmentSrc = typeof segmentSrcProvider === 'function' ? segmentSrcProvider() : (segmentSrcProvider ? segmentSrcProvider.value.trim() : ''); interactionData.options.forEach(opt => this.addOptionToSegmentUI(optionsList, segmentSrc, opt)); }
        interactionPointsListContainer.appendChild(pointDiv);
    }

    addOptionToSegmentUI(optionsListContainer, segmentSrcForOptionDefaults, optionData = {}) {
        const optionDiv = document.createElement('div'); optionDiv.className = 'option-item';
        const createInput = (name, placeholder, value = '', type = 'text', title = '') => { const input = document.createElement('input'); input.type = type; input.name = `option-${name}`; input.placeholder = placeholder; input.value = value; if (title) input.title = title; if (type === 'number') { input.min = "0"; if (['x','w','y','h'].includes(name)) input.max = "100"; } input.addEventListener('input', () => { this.buildConfig(); this.updateStats(); }); return input; };
        optionDiv.appendChild(createInput('label', 'Testo Scelta', optionData.label || 'Opzione'));
        optionDiv.appendChild(createInput('src', 'Video Dest. (o vuoto)', optionData.src === segmentSrcForOptionDefaults ? '' : (optionData.src || ''), 'text', 'Lascia vuoto per usare il video del segmento corrente'));
        optionDiv.appendChild(createInput('start', 'Inizio Clip (es. 1:05)', optionData.start ? this.formatTime(optionData.start) : ''));
        optionDiv.appendChild(createInput('end', 'Fine Clip (opz., es. 1:30)', optionData.end ? this.formatTime(optionData.end) : ''));
        const inputX = createInput('x', 'X%', (optionData.x !== undefined && optionData.x !== null ? optionData.x : ''), 'number', 'Posizione X hotspot (0-100%)');
        const inputY = createInput('y', 'Y%', (optionData.y !== undefined && optionData.y !== null ? optionData.y : ''), 'number', 'Posizione Y hotspot (0-100%)');
        const inputW = createInput('w', 'W%', (optionData.w !== undefined && optionData.w !== null ? optionData.w : ''), 'number', 'Larghezza hotspot (0-100%)');
        const inputH = createInput('h', 'H%', (optionData.h !== undefined && optionData.h !== null ? optionData.h : ''), 'number', 'Altezza hotspot (0-100%)');
        optionDiv.appendChild(inputX); optionDiv.appendChild(inputY); optionDiv.appendChild(inputW); optionDiv.appendChild(inputH);
        const editHotspotBtn = document.createElement('button'); editHotspotBtn.type = 'button'; editHotspotBtn.className = 'btn warning edit-hotspot-btn small-btn'; editHotspotBtn.innerHTML = '‚úèÔ∏è Radar'; editHotspotBtn.title = 'Modifica Hotspot visivamente';
        const segmentElement = optionsListContainer.closest('.segment'); const segmentSrcInputEl = segmentElement ? segmentElement.querySelector("input[name='src']") : null;
        editHotspotBtn.onclick = () => { if (!segmentSrcInputEl || !segmentSrcInputEl.value.trim()) { this.showNotification("Definisci prima l'SRC del video del segmento.", "error"); return; } this.currentEditingOption = { segmentSrcInput: segmentSrcInputEl, optionItemDiv: optionDiv, inputX: inputX, inputY: inputY, inputW: inputW, inputH: inputH }; this.openHotspotModal(); };
        optionDiv.appendChild(editHotspotBtn);
        const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'btn danger remove-option-btn small-btn'; removeBtn.textContent = '‚ûñ Rimuovi'; removeBtn.onclick = () => { optionDiv.remove(); this.buildConfig(); this.updateStats(); };
        optionDiv.appendChild(removeBtn); optionsListContainer.appendChild(optionDiv);
    }

    createSegmentUI(data = {}) { 
        const segmentDiv = document.createElement('div'); segmentDiv.className = 'segment'; 
        segmentDiv.innerHTML = `<div class="form-grid"><div class="form-group"><label>üìÅ Sorgente Video Principale (src):</label><input type='text' name='src' value="${data.src || ''}" placeholder="video.mp4 o playlist.m3u8"></div><div class="form-group"><label>‚è±Ô∏è Durata Video (es. 5:00):</label><input type='text' class='time-input' name='duration' value="${data.duration ? this.formatTime(data.duration) : ''}" placeholder='5:00 o 1:05:30'></div></div><hr><h4>Punti di Interazione nel Video:</h4><div class="interaction-points-list"></div><button type="button" class="btn add-interaction-point-btn">‚ûï Aggiungi Punto di Interazione</button><hr style="margin-top:1.5rem;"><button class='btn danger remove-segment' style="margin-top:1rem;">üóëÔ∏è Rimuovi Segmento Video</button>`; 
        const interactionPointsListContainer = segmentDiv.querySelector('.interaction-points-list'); const addInteractionPointBtn = segmentDiv.querySelector('.add-interaction-point-btn'); const srcInput = segmentDiv.querySelector("input[name='src']"); 
        const getSegmentSrc = () => srcInput.value.trim(); 
        addInteractionPointBtn.onclick = () => { this.addInteractionPointUI(interactionPointsListContainer, getSegmentSrc); this.buildConfig(); this.updateStats();};
        if (data.interactionPoints && Array.isArray(data.interactionPoints)) { data.interactionPoints.forEach(pointData => this.addInteractionPointUI(interactionPointsListContainer, getSegmentSrc, pointData)); } 
        else if (data.time !== undefined || (data.options && data.options.length >0) ) { this.addInteractionPointUI(interactionPointsListContainer, getSegmentSrc, { time: data.time, options: data.options }); }
        segmentDiv.querySelector('.remove-segment').onclick = () => { segmentDiv.remove(); this.buildConfig(); this.updateStats(); }; 
        segmentDiv.querySelectorAll('input[name="src"], input[name="duration"]').forEach(input => { input.addEventListener('input', () => { this.buildConfig(); this.updateStats(); }); }); 
        document.getElementById('segments').appendChild(segmentDiv); 
        if (Object.keys(data).length === 0 || (data.interactionPoints && data.interactionPoints.length === 0 && (data.time === undefined && !data.options)) ) { this.addInteractionPointUI(interactionPointsListContainer, getSegmentSrc); this.buildConfig(); this.updateStats(); } 
    }
    
    buildConfig() { this.storyConfig = { start: null, durations: {}, segments: {} }; Array.from(document.getElementById('segments').children).forEach(segmentEl => { const segmentSrc = segmentEl.querySelector("input[name='src']").value.trim(); if (!segmentSrc) return; const durStr = segmentEl.querySelector("input[name='duration']").value.trim(); const duration = this.parseTime(durStr); if (!this.storyConfig.start) this.storyConfig.start = segmentSrc; this.storyConfig.durations[segmentSrc] = duration; const interactionPointsArray = []; segmentEl.querySelectorAll('.interaction-point-block').forEach(pointEl => { const timeStr = pointEl.querySelector("input[name='interaction_time']").value.trim(); let time = this.parseTime(timeStr); if (timeStr.trim() === '' && duration > 0 && !isNaN(duration)) { time = duration; } else if (timeStr.trim() === '') { time = 0; } const options = []; pointEl.querySelectorAll('.options-list .option-item').forEach(optItem => { options.push({ label: optItem.querySelector("input[name='option-label']").value.trim() || 'Opzione', src: optItem.querySelector("input[name='option-src']").value.trim() || segmentSrc, start: this.parseTime(optItem.querySelector("input[name='option-start']").value.trim()) || 0, end: optItem.querySelector("input[name='option-end']").value.trim() ? this.parseTime(optItem.querySelector("input[name='option-end']").value.trim()) : null, x: optItem.querySelector("input[name='option-x']").value !== '' ? parseFloat(optItem.querySelector("input[name='option-x']").value) : null, y: optItem.querySelector("input[name='option-y']").value !== '' ? parseFloat(optItem.querySelector("input[name='option-y']").value) : null, w: optItem.querySelector("input[name='option-w']").value !== '' ? parseFloat(optItem.querySelector("input[name='option-w']").value) : null, h: optItem.querySelector("input[name='option-h']").value !== '' ? parseFloat(optItem.querySelector("input[name='option-h']").value) : null, }); }); interactionPointsArray.push({ time, options }); }); interactionPointsArray.sort((a, b) => a.time - b.time); this.storyConfig.segments[segmentSrc] = interactionPointsArray; }); }
    exportConfig() { this.buildConfig(); if (Object.keys(this.storyConfig.segments).length === 0) { this.showNotification('Nessun segmento valido (con SRC) da esportare!', 'error'); return; } const blob = new Blob([JSON.stringify(this.storyConfig, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `storia_interattiva_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); this.showNotification('Configurazione esportata con successo!'); }
    importConfig(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { try { const config = JSON.parse(evt.target.result); this.loadConfigToUI(config); this.showNotification('Configurazione importata con successo!'); } catch (error) { console.error("Errore importazione JSON:", error); this.showNotification('Errore nel file JSON! Controlla la console.', 'error'); } }; reader.readAsText(file); event.target.value = ''; }
    loadConfigToUI(config) { document.getElementById('segments').innerHTML = ''; for (const srcKey in config.segments) { const interactionPointsData = config.segments[srcKey]; if (Array.isArray(interactionPointsData)) { this.createSegmentUI({ src: srcKey, duration: config.durations[srcKey], interactionPoints: interactionPointsData }); } else if (config.segments[srcKey] && typeof config.segments[srcKey] === 'object' && config.segments[srcKey] !== null) { /* Tentativo di compatibilit√† con la vecchia struttura singola */ console.warn(`Dati segmento per src "${srcKey}" in formato obsoleto, tento conversione.`); this.createSegmentUI({src: srcKey, duration: config.durations[srcKey], time: config.segments[srcKey].time, options: config.segments[srcKey].options }); } else { console.warn(`Dati segmento per src "${srcKey}" non validi o mancanti.`); this.createSegmentUI({src: srcKey, duration: config.durations[srcKey], interactionPoints: [] }); } } this.buildConfig(); this.updateStats(); }
    shareConfig() { this.buildConfig(); if (Object.keys(this.storyConfig.segments).length === 0) { this.showNotification('Nessun segmento valido (con SRC) da condividere!', 'error'); return; } try { const jsonString = JSON.stringify(this.storyConfig); const encoded = btoa(encodeURIComponent(jsonString)); const link = `${location.origin}${location.pathname}?config=${encoded}`; const input = document.getElementById('share-link'); input.value = link; input.select(); if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(link).then(() => { this.showNotification('Link copiato negli appunti!'); }).catch(err => { console.warn('Copia automatica fallita, fallback:', err); document.execCommand('copy'); this.showNotification('Link copiato negli appunti! (fallback)'); }); } else { document.execCommand('copy'); this.showNotification('Link copiato negli appunti! (fallback)'); } } catch (error) { console.error("Errore creazione link:", error); this.showNotification('Errore nella creazione del link.', 'error'); } }
    clearAll() { if (confirm('Sei sicuro di voler cancellare tutti i segmenti?')) { document.getElementById('segments').innerHTML = ''; this.storyConfig = { start: null, durations: {}, segments: {} }; this.updateStats(); this.showNotification('Tutti i segmenti cancellati.'); } }
    checkUrlConfig() { const params = new URLSearchParams(location.search); if (params.has('config')) { try { const configStr = decodeURIComponent(atob(params.get('config'))); const config = JSON.parse(configStr); this.loadConfigToUI(config); this.showNotification('Configurazione caricata da URL.', 'success'); history.replaceState(null, '', location.pathname); } catch (error) { console.error("Errore caricamento da URL:", error); this.showNotification('Link config non valido/corrotto!', 'error'); } } }
    startPlayer() { this.buildConfig(); if (!this.storyConfig.start) { this.showNotification('Aggiungi almeno un segmento valido (con SRC) per avviare!', 'error'); return; } document.getElementById('builder').style.display = 'none'; document.getElementById('player-container').style.display = 'flex'; this.initPlayer(); }
    backToBuilder() { if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.mozCancelFullScreen) document.mozCancelFullScreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); } document.getElementById('player-container').style.display = 'none'; document.getElementById('builder').style.display = 'block'; this.cleanupVideo(); this.clearChoices(); }
    restartStory() { this.buildConfig(); this.resumeStack = []; this.pendingChoicesInSegment = []; this.nextChoicePointIndex = 0; this.clearChoices(); if (this.storyConfig.start) { this.playSegment(this.storyConfig.start, 0, null); } else { this.showNotification("Nessun segmento iniziale definito.", "error"); this.backToBuilder(); } }
    toggleFullscreen() { const playerElem = document.getElementById('player-container'); if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) { if (playerElem.requestFullscreen) playerElem.requestFullscreen(); else if (playerElem.webkitRequestFullscreen) playerElem.webkitRequestFullscreen(); else if (playerElem.mozRequestFullScreen) playerElem.mozRequestFullScreen(); else if (playerElem.msRequestFullscreen) playerElem.msRequestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.mozCancelFullScreen) document.mozCancelFullScreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); } }
    
    initPlayer() { this.resumeStack = []; this.pendingChoicesInSegment = []; this.nextChoicePointIndex = 0; this.playSegment(this.storyConfig.start, 0, null); }
    playSegment(src, start = 0, end = null) { this.clearChoices(); const video = document.getElementById('video'); const segmentInteractionPoints = this.storyConfig.segments[src]; if (!this.storyConfig.segments.hasOwnProperty(src)) { this.showNotification(`Segmento "${src}" non trovato. Torno al builder.`, "error"); console.error(`Segmento "${src}" non trovato. Config:`, this.storyConfig); this.backToBuilder(); return; } this.pendingChoicesInSegment = segmentInteractionPoints ? [...segmentInteractionPoints].filter(p => p.time >= start).sort((a,b) => a.time - b.time) : []; this.nextChoicePointIndex = 0; const currentTimeOfLastVideo = this.resumeStack.length > 0 ? this.resumeStack[this.resumeStack.length -1].time : video.currentTime; this.resumeStack.push({ src, time: currentTimeOfLastVideo }); this.loadVideo(src, start); this.setupVideoEvents(end, src); }
    loadVideo(src, start) { const video = document.getElementById('video'); const extension = src.split('.').pop().toLowerCase(); this.cleanupVideo(); if ((extension === 'm3u8' || extension === 'm3u') && Hls.isSupported()) { this.currentHls = new Hls({debug:false}); this.currentHls.loadSource(src); this.currentHls.attachMedia(video); this.currentHls.on(Hls.Events.MANIFEST_PARSED, () => { video.currentTime = start; video.play().catch(e => console.warn("Autoplay bloccato:", e)); }); this.currentHls.on(Hls.Events.ERROR, (event, data) => { if (data.fatal) { console.error('HLS Fatal Error:', data); this.showNotification(`Errore HLS: ${data.details}`, 'error'); if (data.type === Hls.ErrorTypes.NETWORK_ERROR && (data.details === Hls.ErrorDetails.MANIFEST_LOAD_ERROR || data.details === Hls.ErrorDetails.LEVEL_LOAD_ERROR)) { this.showNotification(`Errore rete HLS: ${src}. Controlla URL/CORS.`, 'error');}}}); } else { video.src = src; video.onloadedmetadata = () => { video.currentTime = start; video.play().catch(e => console.warn("Autoplay bloccato:", e)); }; video.onerror = (e) => { console.error("Errore caricamento video:", video.error, "Src:", src); this.showNotification(`Errore caricando ${src}: ${video.error?.message || 'Controlla URL/formato.'}`, 'error');}} }
    setupVideoEvents(endMarker, currentSrc) { const video = document.getElementById('video'); video.ontimeupdate = () => { if (endMarker !== null && video.currentTime >= endMarker) { video.pause(); return this.onSegmentEnd(currentSrc, true); } if (this.pendingChoicesInSegment && this.nextChoicePointIndex < this.pendingChoicesInSegment.length) { const nextChoiceDef = this.pendingChoicesInSegment[this.nextChoicePointIndex]; if (video.currentTime >= nextChoiceDef.time) { if (nextChoiceDef.options && nextChoiceDef.options.length > 0) { video.pause(); this.showChoices(nextChoiceDef.options); } this.nextChoicePointIndex++; } } }; video.onended = () => { if (this.pendingChoicesInSegment && this.nextChoicePointIndex < this.pendingChoicesInSegment.length) { const lastPotentialChoiceDef = this.pendingChoicesInSegment[this.pendingChoicesInSegment.length -1]; if (video.duration && Math.abs(video.duration - lastPotentialChoiceDef.time) < 0.5 && this.nextChoicePointIndex === this.pendingChoicesInSegment.length -1 && (!video.paused) ) { if (lastPotentialChoiceDef.options && lastPotentialChoiceDef.options.length > 0) { video.pause(); this.showChoices(lastPotentialChoiceDef.options); } this.nextChoicePointIndex++; } else { this.onSegmentEnd(currentSrc, false); } } else { this.onSegmentEnd(currentSrc, false); } }; }
    showChoices(options) { this.clearChoices(); const playerContainer = document.getElementById('player-container'); const choicesTextDiv = document.getElementById('choices'); let hasHotspots = false; let hasTextButtons = false; options.forEach(option => { if (option.x !== null && option.y !== null && option.w !== null && option.h !== null && !isNaN(parseFloat(option.x)) && !isNaN(parseFloat(option.y)) && !isNaN(parseFloat(option.w)) && parseFloat(option.w) > 0 && !isNaN(parseFloat(option.h)) && parseFloat(option.h) > 0 ) { const box = document.createElement('div'); box.className = 'choice-box'; const w = Math.max(1, parseFloat(option.w)); const h = Math.max(1, parseFloat(option.h)); box.style.left = Math.max(0, Math.min(100 - w, parseFloat(option.x))) + '%'; box.style.top = Math.max(0, Math.min(100 - h, parseFloat(option.y))) + '%'; box.style.width = w + '%'; box.style.height = h + '%'; box.textContent = option.label; box.title = option.label; box.onclick = (e) => { e.stopPropagation(); this.clearChoices(); this.playSegment(option.src, option.start, option.end); }; playerContainer.appendChild(box); hasHotspots = true; } else { const button = document.createElement('button'); button.textContent = option.label; button.className = 'choice-btn'; button.onclick = (e) => { e.stopPropagation(); this.clearChoices(); this.playSegment(option.src, option.start, option.end); }; choicesTextDiv.appendChild(button); hasTextButtons = true; } }); if (hasTextButtons) { choicesTextDiv.style.display = 'flex'; } }
    clearChoices() { document.querySelectorAll('.choice-box').forEach(box => box.remove()); const choicesDiv = document.getElementById('choices'); choicesDiv.innerHTML = ''; choicesDiv.style.display = 'none'; }
    onSegmentEnd(currentSegmentSrc, isOptionEndMarker) { if (this.resumeStack.length > 0) { this.resumeStack.pop(); } if (this.resumeStack.length > 0) { const stateToResume = this.resumeStack[this.resumeStack.length - 1]; this.showNotification(`Fine clip. Torno a: ${stateToResume.src} @ ${this.formatTime(stateToResume.time)}`, 'success'); this.playSegment(stateToResume.src, stateToResume.time); } else { this.showNotification('Fine storia! "Ricomincia" o "Torna al Builder".', 'success'); } }
    cleanupVideo() { const video = document.getElementById('video'); if (video) { video.pause(); video.removeAttribute('src'); video.load(); video.onloadedmetadata = null; video.ontimeupdate = null; video.onended = null; video.onerror = null; } if (this.currentHls) { this.currentHls.destroy(); this.currentHls = null; } }
    openHotspotModal() { const modal = document.getElementById('hotspot-editor-modal'); const segmentVideoSrc = this.currentEditingOption.segmentSrcInput.value.trim(); this.hotspotPreviewState.x = parseFloat(this.currentEditingOption.inputX.value) || 0; this.hotspotPreviewState.y = parseFloat(this.currentEditingOption.inputY.value) || 0; this.hotspotPreviewState.w = parseFloat(this.currentEditingOption.inputW.value) || 20; this.hotspotPreviewState.h = parseFloat(this.currentEditingOption.inputH.value) || 10; this.updateResizableHotspotPreview(); this.updateHotspotValuesPreview(); modal.style.display = 'flex'; if (segmentVideoSrc) { this.loadFrameToCanvas(segmentVideoSrc, this.previewCanvas, this.previewCtx); } else { this.previewCtx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height); this.previewCtx.fillStyle = '#333'; this.previewCtx.fillRect(0, 0, this.previewCanvas.width, this.previewCanvas.height); this.previewCtx.fillStyle = 'white'; this.previewCtx.textAlign = 'center'; this.previewCtx.fillText("Definire SRC video del segmento per l'anteprima.", this.previewCanvas.width / 2, this.previewCanvas.height / 2); } }
    loadFrameToCanvas(videoSrc, canvasElement, canvasCtx) { const tempVideo = this.videoFrameExtractor; tempVideo.src = videoSrc; tempVideo.onloadeddata = () => { if (!tempVideo.videoWidth || !tempVideo.videoHeight) { console.warn("Dimensioni video non disponibili."); canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = '#333'; canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = 'white'; canvasCtx.textAlign = 'center'; canvasCtx.fillText("Dim. video non disp.", canvasElement.width / 2, canvasElement.height / 2); return; } const videoAspectRatio = tempVideo.videoWidth / tempVideo.videoHeight; const canvasContainer = canvasElement.closest('#visual-editor-container') || canvasElement.closest('#timeline-video-container'); if (canvasContainer) { const containerWidth = canvasContainer.clientWidth; let containerHeight = containerWidth / videoAspectRatio; const maxHeight = window.innerHeight * (canvasContainer.id === 'visual-editor-container' ? 0.5 : 0.6); if (containerHeight > maxHeight) { containerHeight = maxHeight; } canvasContainer.style.height = `${containerHeight}px`; } let canvasDrawWidth = tempVideo.videoWidth; let canvasDrawHeight = tempVideo.videoHeight; const isMobile = window.innerWidth < 768; if (isMobile) { const maxMobileDrawDim = 480; if (canvasDrawWidth > maxMobileDrawDim) { canvasDrawWidth = maxMobileDrawDim; canvasDrawHeight = canvasDrawWidth / videoAspectRatio; } } canvasElement.width = canvasDrawWidth; canvasElement.height = canvasDrawHeight; try { tempVideo.currentTime = Math.min(0.1, tempVideo.duration / 2 || 0); } catch (e) { console.warn("Impostare currentTime fallito.", e); tempVideo.currentTime = 0; } }; tempVideo.onseeked = () => { setTimeout(() => { try { canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.drawImage(tempVideo, 0, 0, canvasElement.width, canvasElement.height); } catch (e) { console.error("Errore drawImage:", e); canvasCtx.fillStyle = '#500'; canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = 'white'; canvasCtx.textAlign = 'center'; canvasCtx.fillText("Errore rendering anteprima.", canvasElement.width / 2, canvasElement.height / 2);}}, 50); }; tempVideo.onerror = (e) => { canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = '#500'; canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = 'white'; canvasCtx.textAlign = 'center'; canvasCtx.fillText("Errore caricamento anteprima video.", canvasElement.width / 2, canvasElement.height / 2); console.error("Errore video anteprima:", e, videoSrc); }; if (videoSrc.toLowerCase().includes('.m3u8')) { canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = '#333'; canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height); canvasCtx.fillStyle = 'white'; canvasCtx.textAlign = 'center'; canvasCtx.fillText("Anteprima frame HLS non supportata.\nModifica valori manualmente.", canvasElement.width / 2, canvasElement.height / 2 - 10); } }
    closeHotspotModal() { const modal = document.getElementById('hotspot-editor-modal'); modal.style.display = 'none'; if (this.videoFrameExtractor) this.videoFrameExtractor.src = ""; this.currentEditingOption = { segmentSrcInput: null, optionItemDiv: null, inputX: null, inputY: null, inputW: null, inputH: null }; }
    applyHotspotChanges() { if (this.currentEditingOption.inputX) { this.currentEditingOption.inputX.value = this.hotspotPreviewState.x.toFixed(2); this.currentEditingOption.inputY.value = this.hotspotPreviewState.y.toFixed(2); this.currentEditingOption.inputW.value = this.hotspotPreviewState.w.toFixed(2); this.currentEditingOption.inputH.value = this.hotspotPreviewState.h.toFixed(2); const event = new Event('input', { bubbles: true }); this.currentEditingOption.inputX.dispatchEvent(event); } this.closeHotspotModal(); }
    updateResizableHotspotPreview() { this.resizableHotspotPreview.style.left = `${this.hotspotPreviewState.x}%`; this.resizableHotspotPreview.style.top = `${this.hotspotPreviewState.y}%`; this.resizableHotspotPreview.style.width = `${this.hotspotPreviewState.w}%`; this.resizableHotspotPreview.style.height = `${this.hotspotPreviewState.h}%`; }
    updateHotspotValuesPreview(){ document.getElementById('modal-hotspot-x').textContent = this.hotspotPreviewState.x.toFixed(1); document.getElementById('modal-hotspot-y').textContent = this.hotspotPreviewState.y.toFixed(1); document.getElementById('modal-hotspot-w').textContent = this.hotspotPreviewState.w.toFixed(1); document.getElementById('modal-hotspot-h').textContent = this.hotspotPreviewState.h.toFixed(1); }
    handleHotspotMouseDown(e) { const target = e.target; this.hotspotPreviewState.isDragging = false; this.hotspotPreviewState.isResizing = false; const editorContainer = document.getElementById('visual-editor-container'); if (!editorContainer) return; const rect = editorContainer.getBoundingClientRect(); this.hotspotPreviewState.containerWidth = rect.width; this.hotspotPreviewState.containerHeight = rect.height; if (target.classList.contains('resize-handle')) { e.stopPropagation(); this.hotspotPreviewState.isResizing = true; this.hotspotPreviewState.resizeHandle = target.classList[1]; this.hotspotPreviewState.dragStartX = e.clientX; this.hotspotPreviewState.dragStartY = e.clientY; this.hotspotPreviewState.originalX = this.hotspotPreviewState.x; this.hotspotPreviewState.originalY = this.hotspotPreviewState.y; this.hotspotPreviewState.originalW = this.hotspotPreviewState.w; this.hotspotPreviewState.originalH = this.hotspotPreviewState.h; } else if (target === this.resizableHotspotPreview) { e.stopPropagation(); this.hotspotPreviewState.isDragging = true; const hotspotRect = this.resizableHotspotPreview.getBoundingClientRect(); const offsetX_px = e.clientX - hotspotRect.left; const offsetY_px = e.clientY - hotspotRect.top; this.hotspotPreviewState.dragOffsetXPercent = (offsetX_px / hotspotRect.width) * this.hotspotPreviewState.w; this.hotspotPreviewState.dragOffsetYPercent = (offsetY_px / hotspotRect.height) * this.hotspotPreviewState.h; } }
    handleHotspotMouseMove(e) { if (!this.hotspotPreviewState.isDragging && !this.hotspotPreviewState.isResizing) return; e.preventDefault(); e.stopPropagation(); const visualEditorRect = document.getElementById('visual-editor-container').getBoundingClientRect(); let mouseXRelPercent = ((e.clientX - visualEditorRect.left) / visualEditorRect.width) * 100; let mouseYRelPercent = ((e.clientY - visualEditorRect.top) / visualEditorRect.height) * 100; if (this.hotspotPreviewState.isDragging) { let newX = mouseXRelPercent - this.hotspotPreviewState.dragOffsetXPercent; let newY = mouseYRelPercent - this.hotspotPreviewState.dragOffsetYPercent; this.hotspotPreviewState.x = Math.max(0, Math.min(newX, 100 - this.hotspotPreviewState.w)); this.hotspotPreviewState.y = Math.max(0, Math.min(newY, 100 - this.hotspotPreviewState.h)); } else if (this.hotspotPreviewState.isResizing) { const dxPercent = ((e.clientX - this.hotspotPreviewState.dragStartX) / this.hotspotPreviewState.containerWidth) * 100; const dyPercent = ((e.clientY - this.hotspotPreviewState.dragStartY) / this.hotspotPreviewState.containerHeight) * 100; let { originalX, originalY, originalW, originalH, resizeHandle } = this.hotspotPreviewState; let newX = originalX, newY = originalY, newW = originalW, newH = originalH; if (resizeHandle.includes('e')) newW = originalW + dxPercent; if (resizeHandle.includes('s')) newH = originalH + dyPercent; if (resizeHandle.includes('w')) { newW = originalW - dxPercent; newX = originalX + dxPercent; } if (resizeHandle.includes('n')) { newH = originalH - dyPercent; newY = originalY + dyPercent; } if (newW >= 1) { this.hotspotPreviewState.x = newX; this.hotspotPreviewState.w = newW; } if (newH >= 1) { this.hotspotPreviewState.y = newY; this.hotspotPreviewState.h = newH; } this.hotspotPreviewState.w = Math.max(1, Math.min(this.hotspotPreviewState.w, 100 - this.hotspotPreviewState.x)); this.hotspotPreviewState.h = Math.max(1, Math.min(this.hotspotPreviewState.h, 100 - this.hotspotPreviewState.y)); this.hotspotPreviewState.x = Math.max(0, this.hotspotPreviewState.x); this.hotspotPreviewState.y = Math.max(0, this.hotspotPreviewState.y); } this.updateResizableHotspotPreview(); this.updateHotspotValuesPreview(); }
    handleHotspotMouseUp(e) { if (this.hotspotPreviewState.isDragging || this.hotspotPreviewState.isResizing) { e.preventDefault(); e.stopPropagation(); } this.hotspotPreviewState.isDragging = false; this.hotspotPreviewState.isResizing = false; this.hotspotPreviewState.resizeHandle = null; }
    
    openTimelineModalForInteractionPoint() { const modal = document.getElementById('timeline-editor-modal'); const segmentVideoSrc = this.currentEditingInteractionPoint.segmentSrcProvider(); const currentInteractionTimeStr = this.currentEditingInteractionPoint.timeInput.value.trim(); document.getElementById('current-interaction-point-time').value = currentInteractionTimeStr; this.timelineVideo.src = segmentVideoSrc; this.timelineVideo.load(); document.getElementById('timeline-current-time').textContent = "0:00"; document.getElementById('timeline-total-duration').textContent = "0:00"; this.timelineSlider.value = 0; this.timelineSlider.max = 1000; this.choicePointMarker.style.left = '0%'; modal.style.display = 'flex';}
    updateTimelineUIForInteractionPoint() { if (!this.timelineVideo.duration || !isFinite(this.timelineVideo.duration)) return; const interactionTimeSeconds = this.parseTime(document.getElementById('current-interaction-point-time').value); if (isFinite(interactionTimeSeconds) && this.timelineVideo.duration > 0) { const percent = (interactionTimeSeconds / this.timelineVideo.duration) * 100; this.choicePointMarker.style.left = `${Math.max(0, Math.min(100, percent))}%`; this.timelineSlider.value = interactionTimeSeconds; } else { this.choicePointMarker.style.left = '0%'; this.timelineSlider.value = 0;} }
    setInteractionPointTimeFromVideo() { if (this.timelineVideo && this.timelineVideo.duration > 0 && isFinite(this.timelineVideo.currentTime)) { document.getElementById('current-interaction-point-time').value = this.formatTime(this.timelineVideo.currentTime); this.updateTimelineUIForInteractionPoint(); } }
    applyTimelineChangesForInteractionPoint() { const newTimeStr = document.getElementById('current-interaction-point-time').value; if (this.currentEditingInteractionPoint && this.currentEditingInteractionPoint.timeInput) { this.currentEditingInteractionPoint.timeInput.value = newTimeStr; const event = new Event('input', { bubbles: true }); this.currentEditingInteractionPoint.timeInput.dispatchEvent(event); } this.closeTimelineModal(); }
    closeTimelineModal() { const modal = document.getElementById('timeline-editor-modal'); modal.style.display = 'none'; this.timelineVideo.pause(); this.timelineVideo.removeAttribute('src'); this.timelineVideo.load(); this.currentEditingInteractionPoint = { interactionPointDiv: null, timeInput: null, segmentSrcProvider: null }; }
  }
  document.addEventListener('DOMContentLoaded', () => { window.interactivePlayer = new InteractiveVideoPlayer(); });
</script>
</body>
</html>