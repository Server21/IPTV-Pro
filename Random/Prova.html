<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sito Streaming</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [tabindex]:focus { outline: 3px solid #3B82F6; }
    :root { font-size: 1rem; }
    @media (min-width: 640px) { :root { font-size: 1.1rem; } }
    @media (min-width: 1024px) { :root { font-size: 1.2rem; } }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans leading-normal">
  <header class="bg-gray-900 text-white sticky top-0 z-50">
    <nav class="max-w-screen-2xl mx-auto flex flex-wrap items-center justify-between p-4">
      <h1 class="text-2xl sm:text-3xl font-bold">My Stream</h1>
      <ul class="flex flex-wrap space-x-4 sm:space-x-6" role="menubar">
        <li><button data-type="anime" tabindex="0" class="hover:text-gray-300 focus:text-blue-400">Anime</button></li>
        <li><button data-type="film" tabindex="0" class="hover:text-gray-300 focus:text-blue-400">Film</button></li>
        <li><button data-type="series_tv" tabindex="0" class="hover:text-gray-300 focus:text-blue-400">Serie TV</button></li>
      </ul>
      <div class="flex flex-wrap items-center space-x-2 mt-2 sm:mt-0">
        <input id="search" type="search" placeholder="Cerca..." class="px-3 py-2 rounded bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <select id="genreFilter" class="px-3 py-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">Tutti i generi</option>
        </select>
      </div>
    </nav>
  </header>

  <main class="max-w-screen-2xl mx-auto p-4">
    <div id="gallery"></div>
  </main>

  <script>
    const dataFiles = {
      anime: 'https://raw.githubusercontent.com/Server21/IPTV-Pro/refs/heads/master/Random/anime.json',
      film: 'https://raw.githubusercontent.com/Server21/IPTV-Pro/refs/heads/master/Random/film.json',
      series_tv: 'https://raw.githubusercontent.com/Server21/IPTV-Pro/refs/heads/master/Random/series_tv.json'
    };

    let currentType = 'anime', rawData = [], flatItems = [];
    const gallery = document.getElementById('gallery');
    const searchInput = document.getElementById('search');
    const genreFilter = document.getElementById('genreFilter');
    const navButtons = document.querySelectorAll('nav button');

    async function loadData(type) {
      currentType = type; rawData = []; flatItems = [];
      const res = await fetch(dataFiles[type]); rawData = await res.json();
      if (['anime', 'series_tv'].includes(type)) {
        rawData.forEach((item, seriesIndex) => {
          item.seasons.forEach((season, seasonIndex) => {
            season.episodes.forEach((ep, episodeIndex) => {
              flatItems.push({
                ...ep,
                title: item.title,
                seasonName: season.name,
                seasonIndex,
                seriesIndex,
                episodeIndex,
                poster: ep.still_path || item.poster_path,
                genres: item.genres
              });
            });
          });
        });
      } else {
        flatItems = rawData.map((f, idx) => ({
          ...f,
          seasonName: '',
          seasonIndex: -1,
          seriesIndex: idx,
          episodeIndex: -1,
          poster: f.poster_path,
          genres: f.genres
        }));
      }
      populateGenres(); renderGallery();
    }

    function populateGenres() {
      const opts = ['<option value="">Tutti i generi</option>'];
      new Set(flatItems.flatMap(i => i.genres)).forEach(g => opts.push(`<option value="${g}">${g}</option>`));
      genreFilter.innerHTML = opts.join('');
    }

    function renderGallery() {
      gallery.innerHTML = '';
      const q = searchInput.value.toLowerCase(), g = genreFilter.value;
      if (['anime', 'series_tv'].includes(currentType)) {
        rawData.forEach((item, seriesIndex) => {
          const sec = document.createElement('section');
          const h2 = document.createElement('h2');
          h2.textContent = item.title;
          h2.className = 'text-2xl font-bold mt-6';
          sec.append(h2);
          item.seasons.forEach((season, seasonIndex) => {
            const h3 = document.createElement('h3');
            h3.textContent = season.name;
            h3.className = 'text-xl mt-3 font-semibold';
            sec.append(h3);
            const list = document.createElement('div');
            list.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3';
            season.episodes.forEach((ep, episodeIndex) => {
              if (ep.name.toLowerCase().includes(q) && (!g || item.genres.includes(g))) {
                const card = document.createElement('div');
                card.className = 'cursor-pointer';
                card.innerHTML = `
                  <img src="${ep.still_path || item.poster_path}" class="w-full h-24 object-cover rounded" />
                  <p class="mt-1 text-sm truncate">${ep.name}</p>
                `;
                card.addEventListener('click', () => {
                  const params = new URLSearchParams({
                    videoUrl: ep.file,
                    contentType: currentType,
                    title: item.title,
                    seasonName: season.name,
                    seasonIndex,
                    episodeIndex,
                    skipIntroStart: ep.skipIntroStart,
                    skipIntroEnd: ep.skipIntroEnd,
                    outroStart: ep.outroStart,
                    returnTo: window.location.pathname
                  });
                  window.location.href = `player.html?${params.toString()}`;
                });
                list.append(card);
              }
            });
            sec.append(list);
          });
          gallery.append(sec);
        });
      } else {
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
        flatItems.forEach(i => {
          if (i.title.toLowerCase().includes(q) && (!g || i.genres.includes(g))) {
            const c = document.createElement('div');
            c.className = 'bg-white p-2 rounded shadow cursor-pointer hover:shadow-lg';
            c.innerHTML = `
              <img src="${i.poster}" class="w-full h-32 object-cover rounded"/>
              <h3 class="mt-2 text-lg truncate">${i.title}</h3>
            `;
            c.addEventListener('click', () => {
              const params = new URLSearchParams({
                videoUrl: i.url_video,
                contentType: 'film',
                title: i.title,
                returnTo: window.location.pathname
              });
              window.location.href = `player.html?${params.toString()}`;
            });
            grid.append(c);
          }
        });
        gallery.append(grid);
      }
    }

    searchInput.addEventListener('input', renderGallery);
    genreFilter.addEventListener('change', renderGallery);
    navButtons.forEach(b => b.addEventListener('click', () => loadData(b.dataset.type)));
    loadData(currentType);
  </script>
</body>
</html>
